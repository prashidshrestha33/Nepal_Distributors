<app-otp-popup
  *ngIf="ui.showOtp$ | async"
  (submitOtp)="verifyOtp($event)"
  (resendOtp)="sendOtpAgain()"
  (close)="ui.closeOtp()">
</app-otp-popup>

<div class="flex flex-col justify-start flex-1 w-full max-w-3xl mx-auto px-2 pt-1">

  <!-- Success Modal Overlay -->
  @if (showSuccessMessage) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div class="w-full max-w-md p-8 bg-white rounded-lg shadow-lg">
        <!-- Success Icon -->
        <div class="flex justify-center mb-4">
          <div class="flex items-center justify-center w-16 h-16 bg-green-100 rounded-full">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
        </div>
        
        <!-- Success Message -->
        <h2 class="mb-2 text-lg font-semibold text-center text-gray-800">
          Registration Successful
        </h2>
        <p class="text-sm text-center text-gray-600 mb-6">
          {{ successMessage }}
        </p>

        <!-- Loading indicator -->
        <div class="flex justify-center">
          <div class="text-sm text-gray-500">
            Redirecting to Sign In...
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Main Card -->
  <div class="bg-white rounded-xl p-3 sm:p-4">
    <div class="mb-3 sm:mb-4">
      <h1 class="mb-2 font-semibold text-gray-800 text-title-sm sm:text-title-md" *ngIf="returnUrl==null"  style=" font-size: xx-large">
        Step 2 - Register User
      </h1>
      <h1 class="mb-2 font-semibold text-gray-800 text-title-sm sm:text-title-md" *ngIf="returnUrl!=null"  style=" font-size: xx-large">
        Accept Invite
      </h1>
    </div>

    <!-- Error Message -->
    @if (errorMessage) {
      <div class="p-3 mb-6 text-sm text-red-600 bg-red-50 rounded-lg border border-red-200">
        {{ errorMessage }}
      </div>
    }

<div class="bg-gray-100 rounded-lg shadow p-4 md:p-8">
<!-- Company summary -->
<div *ngIf="returnUrl == null && flow.getCompanyForm()" class="p-2.5 mb-4 text-xs text-gray-700 bg-blue-50 rounded-lg border border-blue-200">
  <strong class="text-blue-900">Company:</strong> 
  <!-- Show name and company type if Componeyid does not exist -->
  <span *ngIf="!Componeyid" class="text-gray-700">
    {{ flow.getCompanyForm().name }} â€” {{ flow.getCompanyForm().companyType }}
  </span>
  
  <!-- Show only name if Componeyid exists -->
  <span *ngIf="Componeyid" class="text-gray-700">
    {{ flow.getCompanyForm().name }}
  </span>
</div>

    <!-- Company document -->
    <div *ngIf="companyFileName && !returnUrl" class="mb-4 p-2.5 bg-green-50 rounded-lg border border-green-200">
      <div class="flex items-center gap-2">
        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <p class="text-xs text-green-800"><strong>Registration document found:</strong> <span class="font-medium">{{ companyFileName }}</span></p>
      </div>
    </div>
    <form [formGroup]="signupForm" (ngSubmit)="onSignUp()" class="space-y-2">
      <!-- Two Column Grid -->
      <div class="grid grid-cols-1 gap-2 sm:grid-cols-2">
        <!-- Full Name -->
        <div class="sm:col-span-1">
          <app-label>
            Full Name <span class="text-error-500">*</span>
          </app-label>
          <input
            type="text"
            placeholder="Enter your full name"
            formControlName="firstName"
            name="firstName"
            class="h-11 w-full rounded-lg border px-4 py-2.5 text-sm shadow-theme-xs placeholder:text-gray-400 focus:outline-none focus:ring-3 text-gray-800 border-gray-300"
            required
          />
          @if (firstName?.invalid && firstName?.touched) {
            <p class="mt-1 text-sm text-red-600">
              @if (firstName?.errors?.['required']) {
                Full name is required
              }
            </p>
          }
        </div>

        <!-- Phone Number -->
        <div class="sm:col-span-1">
          <app-label>
            Phone Number <span *ngIf="returnUrl==null" class="text-error-500">*</span>
          </app-label>
          <input
            type="text"
            placeholder="Enter your phone number"
            formControlName="phoneNo"
            name="phoneNo"
            class="h-11 w-full rounded-lg border px-4 py-2.5 text-sm shadow-theme-xs placeholder:text-gray-400 focus:outline-none focus:ring-3 text-gray-800 border-gray-300"
            required
          />
          @if (phoneNo?.invalid && phoneNo?.touched) {
            <p class="mt-1 text-sm text-red-600">
              @if (phoneNo?.errors?.['required']) {
                Phone number is required
              }
            </p>
          }
        </div>
      </div>

      <!-- Email -->
      <div *ngIf="returnUrl == null">
        <app-label>
          Email <span class="text-error-500">*</span>
        </app-label>

        <div class="flex items-center gap-2">
          <input
            type="email"
            placeholder="info@gmail.com"
            formControlName="email"
            name="email"
            class="h-11 flex-1 rounded-lg border px-4 py-2.5 text-sm shadow-theme-xs placeholder:text-gray-400 focus:outline-none focus:ring-3 text-gray-800 border-gray-300"
            required
          />
          <button
            type="button"
            (click)="onEmailValidatebtnclick()"
            class="h-11 w-11 flex items-center justify-center rounded-lg border border-gray-300 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500"
            title="Validate email"
          >
            <i class="fa-solid fa-envelope"></i>
          </button>
        </div>

        <!-- Email Conflict Error Message -->
<div *ngIf="emailConflictError" class="mt-1 text-sm text-red-600">
  {{ emailConflictError }}
</div>

<!-- Email Validation Errors -->
<div *ngIf="email?.invalid && email?.touched && !emailConflictError" class="mt-1 text-sm text-red-600">
  <ng-container *ngIf="email?.errors?.['required']">
    Email is required
  </ng-container>
  <ng-container *ngIf="email?.errors?.['invalidEmailFormat']">
    Invalid email format
  </ng-container>
</div>

      </div>

      <input *ngIf="returnUrl!=null" formControlName="email" type="hidden" /> 
      <input formControlName="provider" type="hidden" /> 
      <input type="hidden" formControlName="id" /> 
      <input type="hidden" formControlName="token" /> 

      <!-- Terms and Conditions Checkbox -->
      <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
        <div class="flex items-start gap-3">
          <input
            type="checkbox"
            formControlName="agreeToTerms"
            name="agreeToTerms"
            id="agreeToTerms"
            class="w-5 h-5 mt-0.5 text-brand-500 rounded cursor-pointer focus:ring-2 focus:ring-brand-500"
          />
          <div class="flex-1">
            <label for="agreeToTerms" class="text-sm text-gray-700 cursor-pointer select-none">
              I agree to the
              <a href="/terms-and-conditions" target="_blank" rel="noopener noreferrer" class="text-brand-500 hover:text-brand-600 font-medium underline">
                Terms and Conditions
              </a>
            </label>
            @if (agreeToTerms?.invalid && agreeToTerms?.touched) {
              <p class="mt-1 text-sm text-red-600">
                @if (agreeToTerms?.errors?.['required']) {
                  You must accept the Terms and Conditions to proceed
                }
              </p>
            }
          </div>
        </div>
      </div>

      <!-- Submit and Back Buttons -->
      <div class="flex gap-3">
        <button *ngIf="returnUrl==null" type="button" (click)="goBack()" class="flex-1 px-4 py-3 text-sm font-medium text-gray-700 transition rounded-lg bg-gray-100 border border-gray-300 shadow-theme-xs hover:bg-gray-200">
          Back
        </button>

        <button type="submit" [disabled]="isLoading || signupForm.invalid" class="flex-1 flex items-center justify-center px-4 py-3 text-sm font-medium text-white transition rounded-lg bg-brand-500 shadow-theme-xs hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed">
          @if (isLoading) {
            <span class="inline-block w-4 h-4 mr-2 border-2 border-gray-300 border-t-white rounded-full animate-spin"></span>
            Signing up...
          } @else {
            <span *ngIf="returnUrl==null"> Sign Up</span>
            <span *ngIf="returnUrl!=null"> Join Now</span>
          }
        </button>
      </div>
    </form>

    <!-- Sign In Link -->
    <div class="mt-5">
      <p class="text-sm font-normal text-center text-gray-700 sm:text-start">
        Already have an account?
        <a routerLink="/signin" class="text-brand-500 hover:text-brand-600">
          Sign In
        </a>
      </p>
    </div>
    
    </div>
  </div>
</div>
