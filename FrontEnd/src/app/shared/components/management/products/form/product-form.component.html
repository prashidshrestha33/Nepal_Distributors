
<!-- Snackbar Notification -->
<div *ngIf="snackbar.show"
     [ngStyle]="{
       'background-color': snackbar.success ? 'rgba(16, 185, 129, 0.85)' : 'rgba(220, 38, 38, 0.85)'
     }"
     class="fixed top-6 right-6 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-semibold transition-all duration-300 animate-fade-in">
  {{ snackbar.message }}
</div>

<div class="min-h-screen bg-gray-100 dark:bg-gray-800 flex items-center justify-center p-6">
  <div class="w-full max-w-3xl bg-gray-50 dark:bg-gray-900 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700 p-8 space-y-8">

    <h2 class="text-3xl font-extrabold text-gray-800 dark:text-white text-center">
      {{ editMode ? 'Update Product' : 'Add Product' }}
    </h2>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6">

      <!-- Product Name -->
      <div class="space-y-1">
        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
          Name <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          formControlName="name"
          placeholder="Enter product name"
          class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        <span *ngIf="isFieldInvalid('name')" class="text-red-500 text-xs">
          Name is required.
        </span>
      </div>

      <!-- Product Details -->
      <div class="space-y-1">
        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
          Details
        </label>
        <textarea
          formControlName="description"
          rows="3"
          placeholder="Enter product description"
          class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        ></textarea>
      </div>
<!-- Product Image Upload -->
<div class="space-y-1">
  <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
     Image
  </label>

  <!-- Upload Box -->
  <div
    class="relative flex items-center justify-center h-44 w-full
           border-2 border-dashed rounded-xl cursor-pointer
           transition-all duration-200
           bg-gray-50 dark:bg-gray-800
           border-gray-300 dark:border-gray-600
           hover:border-blue-500 hover:bg-blue-50/40"
    (click)="fileInput.click()"
    (dragover)="onDragOver($event)"
    (dragleave)="onDragLeave($event)"
    (drop)="onDrop($event)"
  >

    <!-- Image Preview -->
    <ng-container *ngIf="imagePreview; else uploadPlaceholder">
      <img
        [src]="imagePreview"
        class="absolute inset-0 h-full w-full object-cover rounded-xl"
      />

      <!-- Remove Button -->
      <button
        type="button"
        (click)="removeImage()"
        class="absolute top-2 right-2 bg-black/60 text-white
               rounded-full h-7 w-7 flex items-center justify-center
               hover:bg-black"
      >
        ✕
      </button>
    </ng-container>

    <!-- Placeholder -->
    <ng-template #uploadPlaceholder>
      <div class="text-center pointer-events-none">
        <!-- Cloud Icon -->
        <svg xmlns="http://www.w3.org/2000/svg"
             class="mx-auto h-10 w-10 text-blue-500 mb-2"
             fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6
                   a5 5 0 011 9.9M12 12v6m0 0l-3-3m3 3l3-3" />
        </svg>

        <p class="text-sm text-gray-600 dark:text-gray-300">
          <span class="font-medium text-blue-600">Click to upload</span>
          or drag and drop
        </p>
        <p class="text-xs text-gray-400 mt-1">
          PNG, JPG up to 5MB
        </p>
      </div>
    </ng-template>

    <!-- Hidden File Input -->
    <input
      #fileInput
      type="file"
      accept="image/*"
      class="hidden"
      (change)="onProductImageChange($event)"
    />
  </div>
</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Product Rate -->
        <div class="space-y-1">
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
               Rate <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              formControlName="rate"
              placeholder="Rate"
              min="0"
              step="1"
              pattern="\d*"
              inputmode="numeric"
              class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 no-spinner"
            />
            <span *ngIf="isFieldInvalid('rate')" class="text-red-500 text-xs">
             Rate is required.
            </span>
          </div>

        <!-- HS Code -->
        <div class="space-y-1">
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">HS Code</label>
           <input
            type="text"
            formControlName="hsCode"
            placeholder="HS Code"
            class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
           />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <!-- Category -->
        <div class="space-y-1 relative">
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
            Category <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <button
              type="button"
              class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10"
              (click)="showCategoryMenu = !showCategoryMenu"
            >
              {{ getCategoryName(form.get('categoryId')?.value) || 'Select Category' }}
            </button>
            <!--Clear Category -->
            <button
              *ngIf="form.get('categoryId')?.value"
              type="button"
              class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-red-600"
              (click)="clearCategory()"
            >
              ✕
            </button>

            <div *ngIf="showCategoryMenu" class="absolute z-10 mt-1 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-64 overflow-auto">
              <ul>
                <li *ngFor="let cat of treeCategories">
                  <button
                    type="button"
                    class="w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-blue-900"
                    (click)="selectCategory(cat)"
                  >
                    {{ cat.name }}
                  </button>
                </li>
              </ul>
            </div>
          </div>
          <span *ngIf="isFieldInvalid('categoryId')" class="text-red-500 text-xs">
            Category is required.
          </span>
        </div>

        <!-- Brand -->
        <div class="space-y-1 relative">
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
            Brand <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <button
              type="button"
              class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10"
              (click)="showBrandMenu = !showBrandMenu"
            >
              {{ getBrandName(form.get('brandId')?.value) || 'Select Brand' }}
            </button>
            <!--Clear Brand -->
            <button
              *ngIf="form.get('brandId')?.value"
              type="button"
              class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-red-600"
              (click)="clearBrand()"
            >
              ✕
            </button>

            <div *ngIf="showBrandMenu" class="absolute z-10 mt-1 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-64 overflow-auto">
              <ul>
                <li *ngFor="let brand of filteredItems">
                  <button
                    type="button"
                    class="w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-blue-900"
                    (click)="selectBrand(brand)"
                  >
                    {{ brand.staticValueKey }}
                  </button>
                </li>
              </ul>
            </div>
          </div>
          <span *ngIf="isFieldInvalid('brandId')" class="text-red-500 text-xs">
            Brand is required.
          </span>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <!-- Manufacturer -->
        <div class="space-y-1 relative">
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
            Manufacture <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <button
              type="button"
              class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-left focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10"
              (click)="showManufactureMenu = !showManufactureMenu"
            >
              {{ getManufactureName(form.get('manufacturerId')?.value) || 'Select Manufacture' }}
            </button>
            <!--Clear Brand -->
            <button
              *ngIf="form.get('manufacturerId')?.value"
              type="button"
              class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-red-600"
              (click)="clearManufacture()"
            >
              ✕
            </button>

            <div *ngIf="showManufactureMenu" class="absolute z-10 mt-1 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-64 overflow-auto">
              <ul>
                <li *ngFor="let manufacture of filteredManufacture">
                  <button
                    type="button"
                    class="w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-blue-900"
                    (click)="selectManufacture(manufacture)"
                  >
                    {{ manufacture.staticValueKey }}
                  </button>
                </li>
              </ul>
            </div>
          </div>
          <span *ngIf="isFieldInvalid('manufacture')" class="text-red-500 text-xs">
            Manufacture is required.
          </span>
        </div>
      </div>
      <!-- Error -->
      <div *ngIf="error" class="text-red-600 font-medium text-sm p-3 bg-red-50 border border-red-300 rounded-lg">
        {{ error }}
      </div>      
      <!-- Buttons -->
      <div class="flex gap-4 justify-end">
        <button
          type="button"
          (click)="goBack()"
          class="bg-gray-500 hover:bg-gray-600 text-white font-bold px-6 py-2 rounded-lg shadow-md transition"
        >
          Cancel
        </button>
        <button
          type="submit"
          [disabled]="form.invalid || loading"
          class="px-6 py-2 rounded-lg font-bold shadow-md transition
                 bg-blue-600 text-white
                 hover:bg-blue-700
                 disabled:bg-gray-400
                 disabled:cursor-not-allowed
                 disabled:hover:bg-gray-400"
        >
          {{ loading ? (editMode ? 'Updating...' : 'Saving...') : (editMode ? 'Update Product' : 'Save Product') }}
        </button>
      </div>
    </form>
  </div>
</div>
